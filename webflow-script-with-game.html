<div id="app-main-container"></div>

<script>
window.JPApp = {
  // --- CONFIGURATION ---
  config: {
    owner: "gryswynd",
    repo: "jp-lessons",
    branch: "main",
    path: ""
  },

  // --- STATE ---
  state: {
    flags: JSON.parse(localStorage.getItem('k-flags') || '{}')
  },

  // --- HELPER: Load Scripts from Raw GitHub ---
  loadModule: async function(fileName) {
    const url = `https://raw.githubusercontent.com/${this.config.owner}/${this.config.repo}/${this.config.branch}/${fileName}`;

    // Add timestamp to bypass browser caching completely
    const cacheBuster = url + '?t=' + Date.now();

    try {
      const res = await fetch(cacheBuster);
      if (!res.ok) throw new Error(`Failed to load ${fileName}`);
      const code = await res.text();

      // Create a script element with the fetched code
      const script = document.createElement('script');
      script.textContent = code;
      document.body.appendChild(script);

      console.log(`Successfully loaded ${fileName}`);
      return true;
    } catch (err) {
      console.error(err);
      this.container.innerHTML = `<div style="color:red; text-align:center; padding:20px;">Error loading ${fileName}:<br>${err.message}</div><button onclick="JPApp.renderMenu()" style="margin:20px auto; display:block;">Back</button>`;
      return false;
    }
  },

  // --- INIT ---
  init: function() {
    this.container = document.getElementById('app-main-container');
    if (!this.container) return console.error("Container #app-main-container not found");
    this.renderMenu();
  },

  // --- RENDER MENU ---
  renderMenu: function() {
    this.container.innerHTML = '';

    // Menu Styles
    const style = `
      <style>
        .jp-main-menu {
            width: 100%; max-width: 600px; margin: 0 auto; font-family: 'Poppins', sans-serif;
            text-align: center; display: grid; gap: 15px; padding: 20px;
        }
        .jp-menu-btn {
            background: white; padding: 25px; border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer;
            transition: transform 0.2s; border: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column; align-items: center;
        }
        .jp-menu-btn:active { transform: scale(0.98); }
        .jp-menu-title { font-size: 1.2rem; font-weight: 900; color: #4e54c8; margin-bottom: 5px; }
        .jp-menu-desc { color: #747d8c; font-size: 0.9rem; }
      </style>
    `;

    const html = `
      ${style}
      <div class="jp-main-menu">
        <h1 style="color:#2f3542; font-weight:900;">üáØüáµ Japanese Master</h1>

        <div class="jp-menu-btn" onclick="JPApp.launch('lesson')">
            <div class="jp-menu-title">üìö Lessons</div>
            <div class="jp-menu-desc">Structured paths & reading</div>
        </div>

        <div class="jp-menu-btn" onclick="JPApp.launch('practice')">
            <div class="jp-menu-title">‚öîÔ∏è Practice</div>
            <div class="jp-menu-desc">Flashcards & Quizzes</div>
        </div>

        <div class="jp-menu-btn" onclick="JPApp.launch('review')">
            <div class="jp-menu-title">üìù Review Test</div>
            <div class="jp-menu-desc">Assessment & Drills</div>
        </div>

        <div class="jp-menu-btn" onclick="JPApp.launch('game')">
            <div class="jp-menu-title">üéÆ House Adventure</div>
            <div class="jp-menu-desc">Interactive Japanese game</div>
        </div>
      </div>
    `;

    this.container.innerHTML = html;
  },

  // --- LAUNCHER ---
  launch: async function(mode) {
    this.container.innerHTML = '<div style="padding:40px; text-align:center; color:#888;">Fetching latest code from GitHub...</div>';
    const onExit = () => this.renderMenu();

    if (mode === 'lesson') {
      if (!window.LessonModule) {
         const success = await this.loadModule('Lesson.js');
         if (!success) return;
      }
      if (window.LessonModule) window.LessonModule.start(this.container, this.config, onExit);
    }
    else if (mode === 'practice') {
      if (!window.PracticeModule) {
         const success = await this.loadModule('Practice.js');
         if (!success) return;
      }
      if (window.PracticeModule) window.PracticeModule.start(this.container, this.config, onExit);
    }
    else if (mode === 'review') {
      if (!window.ReviewModule) {
         const success = await this.loadModule('Review.js');
         if (!success) return;
      }
      if (window.ReviewModule) window.ReviewModule.start(this.container, this.config, onExit);
    }
    else if (mode === 'game') {
      if (!window.GameModule) {
         const success = await this.loadModule('Game.js');
         if (!success) return;
      }
      if (window.GameModule) window.GameModule.start(this.container, this.config, onExit);
    }
  }
};

// Start App
document.addEventListener('DOMContentLoaded', () => window.JPApp.init());
</script>

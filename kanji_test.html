<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
    /* --- THEME --- */
    #kanji-app-root {
        --primary: #4e54c8; --primary-dark: #3f44a5; --accent: #ff4757;
        --bg-grad: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        --card-bg: #ffffff; --text-main: #2f3542; --text-sub: #747d8c;
        --success: #2ed573; --error: #ff4757;

        font-family: 'Poppins', 'Noto Sans JP', sans-serif;
        background: var(--bg-grad); color: var(--text-main);
        display: flex; flex-direction: column;
        height: 800px; width: 100%; max-width: 600px; margin: 0 auto;
        border: 1px solid rgba(0,0,0,0.05); border-radius: 20px;
        overflow: hidden; position: relative;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }

    /* HEADER */
    #kanji-app-root header {
        background: rgba(78, 84, 200, 0.95); color: white; padding: 1.2rem;
        text-align: center; font-weight: 900; letter-spacing: 0.05em; font-size: 1.2rem;
        cursor: pointer; user-select: none; z-index: 10;
        box-shadow: 0 4px 15px rgba(78, 84, 200, 0.3); backdrop-filter: blur(5px);
    }

    /* APP CONTAINER */
    #k-app-container { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; align-items: center; width: 100%; position: relative; z-index: 1; }

    /* CARDS */
    .k-card {
        background: var(--card-bg); border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.05); padding: 2rem; width: 100%;
        text-align: center; margin-bottom: 1.5rem; position: relative;
        transition: transform 0.2s ease; border: 1px solid rgba(0,0,0,0.02);
    }

    /* TEXT */
    .k-big { font-family: 'Noto Sans JP', sans-serif; font-size: 5rem; margin: 0.2rem 0; color: var(--text-main); font-weight: 900; line-height: 1.1; }
    .k-sub { font-size: 1.4rem; color: var(--text-sub); font-weight: 500; margin-bottom: 0.5rem; }
    .k-lbl { font-size: 0.8rem; text-transform: uppercase; color: #a4b0be; font-weight: 700; letter-spacing: 0.1em; margin-top: 5px; }

    /* LESSON SELECTOR STYLES */
    .k-filters { width: 100%; display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }

    .k-lvl-group { width: 100%; text-align: left; background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: 1px solid #dfe4ea; overflow: hidden; }

    .k-lvl-header {
        display: flex; align-items: center; padding: 12px 15px;
        cursor: pointer; background: #f8f9fa; transition: background 0.2s;
        border-bottom: 1px solid transparent;
    }
    .k-lvl-header:hover { background: #f1f2f6; }
    .k-lvl-header.open { border-bottom-color: #dfe4ea; background: white; }

    .k-lvl-title { flex: 1; font-weight: 700; color: var(--text-main); font-size: 1.1rem; margin-left: 10px; }
    .k-lvl-arrow { transition: transform 0.3s; color: #a4b0be; font-size: 0.8rem; }
    .k-lvl-header.open .k-lvl-arrow { transform: rotate(180deg); }

    .k-lvl-list { display: none; padding: 5px 0; background: white; max-height: 300px; overflow-y: auto; }
    .k-lvl-list.open { display: block; animation: k-slide-down 0.3s ease-out; }

    .k-lesson-row {
        display: flex; align-items: flex-start; padding: 10px 15px;
        border-bottom: 1px solid #f1f2f6; font-size: 0.9rem; transition: background 0.1s;
    }
    .k-lesson-row:last-child { border-bottom: none; }
    .k-lesson-row:hover { background: #fdfbfb; }

    .k-chk {
        width: 18px; height: 18px; margin-right: 12px; margin-top: 3px;
        accent-color: var(--primary); cursor: pointer;
    }

    .k-l-info { flex: 1; cursor: pointer; }
    .k-l-topic { font-weight: 600; color: var(--text-main); margin-bottom: 2px; }
    .k-l-kanji { font-size: 0.8rem; color: var(--text-sub); font-family: 'Noto Sans JP'; line-height: 1.4; }

    /* FLAG STAMP */
    .k-flag-stamp {
        position: absolute; top: 15px; right: 15px;
        color: #ff4757; border: 3px solid #ff4757;
        padding: 5px 12px; border-radius: 8px;
        font-weight: 900; text-transform: uppercase;
        transform: rotate(15deg); font-size: 1rem; letter-spacing: 0.1em;
        opacity: 0.8; animation: k-stamp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        pointer-events: none; z-index: 5;
    }

    @keyframes k-slide-down { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes k-stamp { 0%{transform: scale(2) rotate(15deg); opacity:0;} 100%{transform: scale(1) rotate(15deg); opacity:0.8;} }

    /* BUTTONS */
    .k-btn {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white; border: none; padding: 16px; border-radius: 12px;
        font-size: 1.1rem; font-weight: 700; width: 100%; margin: 8px 0;
        cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px rgba(78, 84, 200, 0.2);
    }
    .k-btn:active { transform: scale(0.98); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .k-btn-sec { background: white; color: var(--text-sub); border: 2px solid #dfe4ea; background: none; box-shadow: none; }
    .k-btn-sec:hover { background: #f1f2f6; border-color: #ced6e0; }

    /* SMALL GRID BUTTONS */
    .k-grid-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 8px 0; }
    .k-grid-btns .k-btn { font-size: 0.9rem; padding: 12px; margin: 0; }

    /* QUIZ OPTIONS */
    .k-opt {
        background: white; border: 2px solid #dfe4ea; padding: 16px; border-radius: 12px;
        text-align: center; margin-bottom: 10px; cursor: pointer; font-weight: 600;
        font-size: 1.1rem; color: var(--text-main); min-height: 54px;
        display: flex; align-items: center; justify-content: center; transition: all 0.15s;
    }
    .k-opt:hover { border-color: var(--primary); color: var(--primary); background: #f8f9fe; }
    .k-opt.correct { background: var(--success); border-color: var(--success); color: white; animation: k-pop 0.3s; }
    .k-opt.wrong { background: var(--error); border-color: var(--error); color: white; animation: k-shake 0.4s; }

    /* TABLES */
    .k-tbl { width: 100%; text-align: left; font-size: 1.15rem; margin-top: 1rem; border-collapse: collapse; }
    .k-tbl td { padding: 12px 8px; border-bottom: 1px solid #f1f2f6; color: var(--text-main); vertical-align: top; }
    .k-tbl th { padding: 12px 8px; color: #a4b0be; font-weight: 600; font-size: 0.9rem; width: 30%; border-bottom: 1px solid #f1f2f6; text-transform: uppercase; }

    /* STATS & UTILS */
    .k-stats-bar { display: flex; justify-content: space-between; width: 100%; margin-bottom: 15px; font-size: 0.9rem; font-weight: 800; color: #a4b0be; letter-spacing: 0.05em; }
    .k-streak { color: #ffa502; text-shadow: 0 2px 10px rgba(255, 165, 2, 0.2); }
    .k-hidden { display: none !important; }

    /* LOADER */
    #k-loader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; }

    @keyframes k-pop { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes k-shake { 0%, 100% { transform: translateX(0); } 20% { transform: translateX(-6px); } 80% { transform: translateX(6px); } }
</style>

<div id="kanji-app-root">
    <div id="k-loader">
        <div style="font-size: 3rem; margin-bottom: 15px;">üáØüáµ</div>
        <div style="font-weight:800; color:#4e54c8; font-size:1.2rem">Loading Library...</div>
        <div id="k-error-box" class="k-hidden" style="color:#ff4757; margin-top:10px; padding:10px; max-width:80%; font-size:0.9rem"></div>
    </div>

    <header onclick="kShowMenu()">Kanji Master ÂÖàÁîü</header>

    <div id="k-app-container">
        <div id="k-view-menu" style="width:100%">

            <div class="k-card" style="padding: 1.5rem; margin-bottom: 25px;">
                <div style="display:flex; justify-content:space-around; align-items:center;">
                    <div><div class="k-big" style="font-size:2.2rem; color:var(--primary)" id="k-cnt-k">0</div><div class="k-lbl">Kanji Selected</div></div>
                    <div style="width:1px; height:40px; background:#eee;"></div>
                    <div><div class="k-big" style="font-size:2.2rem; color:#8e44ad" id="k-cnt-v">0</div><div class="k-lbl">Verbs Loaded</div></div>
                </div>
            </div>

            <div class="k-card" style="padding: 1rem; margin-bottom: 25px; display:flex; justify-content:space-around; align-items:center; background:#f8f9fa; border:1px solid #dfe4ea;">
                <div><div style="font-size:1.4rem; font-weight:800; color:var(--primary)" id="k-hs-meaning">0</div><div class="k-lbl" style="font-size:0.7rem;">Meaning Best</div></div>
                <div style="width:1px; height:30px; background:#ddd;"></div>
                <div><div style="font-size:1.4rem; font-weight:800; color:var(--primary)" id="k-hs-reading">0</div><div class="k-lbl" style="font-size:0.7rem;">Reading Best</div></div>
                <div style="width:1px; height:30px; background:#ddd;"></div>
                <div><div style="font-size:1.4rem; font-weight:800; color:var(--primary)" id="k-hs-vocab">0</div><div class="k-lbl" style="font-size:0.7rem;">Vocab Best</div></div>
            </div>

            <div class="k-lbl" style="margin-bottom:12px; color: var(--primary);">SELECT LESSONS</div>
            <div class="k-filters" id="k-lesson-container"></div>

            <div class="k-lbl" style="margin-top:1rem">KANJI PRACTICE</div>
            <button class="k-btn" onclick="kStart('kanji', 'flash')">üé¥ Flashcards</button>

            <div class="k-lbl" style="margin-top:8px">MEANING QUIZ</div>
            <div class="k-grid-btns">
                <button class="k-btn" onclick="kStart('kanji', 'quiz-meaning', 'normal')">Kanji ‚ûî Eng</button>
                <button class="k-btn" onclick="kStart('kanji', 'quiz-meaning', 'reverse')">Eng ‚ûî Kanji</button>
                <button class="k-btn" onclick="kStart('kanji', 'quiz-meaning', 'mix')">üîÑ Mix</button>
            </div>

            <div class="k-lbl" style="margin-top:8px">READING QUIZ</div>
            <div class="k-grid-btns">
                <button class="k-btn" onclick="kStart('kanji', 'quiz-reading', 'normal')">Kanji ‚ûî Read</button>
                <button class="k-btn" onclick="kStart('kanji', 'quiz-reading', 'reverse')">Read ‚ûî Kanji</button>
                <button class="k-btn" onclick="kStart('kanji', 'quiz-reading', 'mix')">üîÑ Mix</button>
            </div>

            <button class="k-btn" onclick="kStart('kanji', 'quiz-vocab')">üìù Vocab Quiz</button>

            <div class="k-lbl" style="margin-top:2rem">VERB PRACTICE</div>
            <button class="k-btn" style="background: linear-gradient(135deg, #8e44ad 0%, #6c3483 100%);" onclick="kStart('verb', 'flash')">üèÉ Verb Flashcards</button>
            <button class="k-btn" style="background: linear-gradient(135deg, #8e44ad 0%, #6c3483 100%);" onclick="kStart('verb', 'quiz-conj')">‚ö° Conjugation Quiz</button>
        </div>

        <div id="k-view-flash" class="k-hidden" style="width:100%">
            <div class="k-stats-bar" style="justify-content:center; opacity:0.6;">
                <span id="k-fc-progress">Card 1 / 100</span>
            </div>
            <div class="k-card" id="k-fc-card-container" style="min-height: 300px; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <div id="k-fc-front">
                    <div class="k-lbl" id="k-fc-lbl" style="color:var(--primary)"></div>
                    <div class="k-big" id="k-fc-main"></div>
                    <div class="k-sub" id="k-fc-sub"></div>
                </div>
                <div id="k-fc-back" class="k-hidden" style="text-align:left; width:100%"></div>
            </div>

            <button class="k-btn k-btn-sec" id="k-btn-flip" onclick="kFlip()" style="border-color:var(--primary); color:var(--primary)">Show Details</button>

            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:15px; width:100%">
                <button class="k-btn k-btn-sec" onclick="kMove(-1)">Prev</button>
                <button class="k-btn k-btn-sec" onclick="kFlag(this)" style="color:#f39c12; border-color:#f39c12;">Flag üö©</button>
                <button class="k-btn k-btn-sec" onclick="kMove(1)">Next</button>
            </div>
            <button class="k-btn k-btn-sec" onclick="kShowMenu()" style="margin-top:10px; border:none; color:#a4b0be; font-size:0.9rem">Return to Menu</button>
        </div>

        <div id="k-view-quiz" class="k-hidden" style="width:100%; display:flex; flex-direction:column; height:100%">
            <div class="k-stats-bar">
                <span>üèÜ BEST: <span id="k-best">0</span></span>
                <span class="k-streak">üî• STREAK: <span id="k-streak">0</span></span>
            </div>
            <div class="k-card">
                <div class="k-lbl" style="margin-bottom:10px;" id="k-q-lbl">QUESTION</div>
                <div class="k-big" id="k-q-main"></div>
                <div id="k-q-read-reveal" class="k-hidden" style="color:#8e44ad; font-weight:700; font-size:1.5rem; margin-top:5px; animation:k-pop 0.3s"></div>
                <div class="k-sub" id="k-q-ask" style="margin-top:10px; color:var(--primary)"></div>
            </div>
            <div id="k-q-opts"></div>
            <div id="k-q-msg" class="k-hidden" style="margin:10px 0; font-weight:bold; padding:15px; border-radius:12px; text-align:center;"></div>
            <div style="margin-top:auto; width:100%">
                <button class="k-btn k-hidden" id="k-q-next" onclick="kNextQ()">Next Question ‚ûú</button>
                <button class="k-btn k-btn-sec" onclick="kShowMenu()">Exit Quiz</button>
            </div>
        </div>
    </div>
</div>

<script>
    const KANJI_URL = 'https://cdn.prod.website-files.com/60c4f4461bc9c580d63d900e/69461d15282f4f9e6c85c600_RC%20Kanji%20List.xlsx%20-%20Kanji.csv';
    const VERBS_URL = 'https://cdn.prod.website-files.com/60c4f4461bc9c580d63d900e/6931d54b9dc1f8ddbe1cf4a5_RC%20Kanji%20List.xlsx%20-%20Verb%20Conjugation%20.csv';
    const LESSONS_URL = 'https://cdn.prod.website-files.com/60c4f4461bc9c580d63d900e/69461d1544baa02580226b75_RC%20Kanji%20List.xlsx%20-%20Lessons.csv';

    const DB = { kanji: [], verb: [], lessons: [] };
    const activeLessons = new Set();

    // SCORE TRACKING
    let curSet=[], curIdx=0, curStreak=0, curBest=0, curMode='', curAns='', curType='', curSubMode='normal', curQItem=null, curCategory='';
    let quizPhase = 1;
    let curVocabItem = null;
    let flagCounts = JSON.parse(localStorage.getItem('k-flags')) || {};

    // Load Saved High Scores
    const bestScores = {
        meaning: parseInt(localStorage.getItem('k-best-meaning') || '0'),
        reading: parseInt(localStorage.getItem('k-best-reading') || '0'),
        vocab: parseInt(localStorage.getItem('k-best-vocab') || '0'),
        verb: parseInt(localStorage.getItem('k-best-verb') || '0')
    };

    (async function() {
        try {
            const [kData, vData, lData] = await Promise.all([
                kFetch(KANJI_URL, 'kanji'),
                kFetch(VERBS_URL, 'verb'),
                kFetch(LESSONS_URL, 'lesson')
            ]);

            DB.kanji = kData;
            DB.verb = vData;
            DB.lessons = lData;

            kBuildMenu();
            kUpdateStats();
            document.getElementById('k-loader').classList.add('k-hidden');

        } catch(e) {
            document.getElementById('k-error-box').innerText = e.message || "Error loading data.";
            document.getElementById('k-error-box').classList.remove('k-hidden');
        }
    })();

    async function kFetch(url, type) {
        const res = await fetch(url);
        if(!res.ok) throw new Error(`Failed to load ${type}`);
        const txt = await res.text();
        const lines = txt.trim().split('\n');
        if(lines.length<2) return [];
        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, '').replace(/^\ufeff/, ''));

        return lines.slice(1).map(line => {
            const cols = []; let current = ''; let inQuote = false;
            for(let i=0; i<line.length; i++){
                const c = line[i];
                if(c==='"') inQuote = !inQuote;
                else if(c===',' && !inQuote) { cols.push(current); current=''; }
                else current += c;
            } cols.push(current);

            const row = {};
            headers.forEach((h, i) => {
                let val=(cols[i]||'').trim();
                if(val.startsWith('"')) val=val.slice(1,-1);
                row[h]=val.replace(/""/g, '"');
            });

            if(type==='kanji') {
                return {
                    class: row['Class'],
                    kanji: row['Kanji'],
                    lesson: row['Lesson'],
                    kun: row['KunReadings'],
                    on: row['OnReadings'],
                    meaning: row['EnglishMeaning'],
                    compounds: row['Vocabulary'],
                    comp_readings: row['Readings'],
                    comp_meanings: row['Meanings']
                };
            } else if (type==='lesson') {
                return { id: row['Lesson'], topic: row['Topic'], kanji_list: row['Kanji'] };
            } else {
                return { kanji: row['Kanji']||'-', dict: row['Reading (Dict)'], meaning: row['Meaning'], masu: row['Masu (Polite)'], te: row['Te-Form (Gerund)'], nai: row['Nai-Form (Negative)'], ta: row['Ta-Form (Past)'], potential: row['Potential (Can do)'] };
            }
        }).filter(d => (type==='kanji' ? d.kanji : d.meaning || d.id));
    }

    function kBuildMenu() {
        const container = document.getElementById('k-lesson-container');
        container.innerHTML = '';
        const groups = {};
        DB.lessons.forEach(l => {
            const cls = l.id.split('.')[0];
            if(!groups[cls]) groups[cls] = [];
            groups[cls].push(l);
            activeLessons.add(l.id);
        });

        Object.keys(groups).sort().forEach(cls => {
            const lessons = groups[cls];
            const div = document.createElement('div');
            div.className = 'k-lvl-group';
            div.innerHTML = `
                <div class="k-lvl-header" onclick="kToggleAccordion(this)">
                    <input type="checkbox" class="k-chk" checked onclick="event.stopPropagation(); kToggleAll('${cls}', this)">
                    <div class="k-lvl-title">${cls}</div>
                    <div class="k-lvl-arrow">‚ñº</div>
                </div>
                <div class="k-lvl-list">
                    ${lessons.map(l => {
                        const num = l.id.split('.')[1] || l.id;
                        return `
                        <div class="k-lesson-row">
                            <input type="checkbox" class="k-chk k-chk-${cls}" value="${l.id}" checked onchange="kUpdateLesson('${l.id}', '${cls}')">
                            <div class="k-l-info" onclick="this.previousElementSibling.click()">
                                <div class="k-l-topic">Lesson ${num}: ${l.topic}</div>
                                <div class="k-l-kanji">${l.kanji_list}</div>
                            </div>
                        </div>
                    `}).join('')}
                </div>
            `;
            container.appendChild(div);
        });
    }

    function kToggleAccordion(header) { header.classList.toggle('open'); header.nextElementSibling.classList.toggle('open'); }
    function kToggleAll(cls, parentChk) {
        document.querySelectorAll(`.k-chk-${cls}`).forEach(box => {
            box.checked = parentChk.checked;
            if(parentChk.checked) activeLessons.add(box.value); else activeLessons.delete(box.value);
        });
        kUpdateStats();
    }
    function kUpdateLesson(id, cls) {
        if(activeLessons.has(id)) activeLessons.delete(id); else activeLessons.add(id);
        const all = document.querySelectorAll(`.k-chk-${cls}`);
        const checked = document.querySelectorAll(`.k-chk-${cls}:checked`);
        const parent = all[0].closest('.k-lvl-group').querySelector('.k-lvl-header input');
        parent.checked = (all.length === checked.length);
        parent.indeterminate = (checked.length > 0 && checked.length < all.length);
        kUpdateStats();
    }
    function kUpdateStats() {
        document.getElementById('k-cnt-k').innerText = DB.kanji.filter(k => activeLessons.has(k.lesson)).length;
        document.getElementById('k-cnt-v').innerText = DB.verb.length;
        // Update High Scores on Menu
        document.getElementById('k-hs-meaning').innerText = bestScores.meaning;
        document.getElementById('k-hs-reading').innerText = bestScores.reading;
        document.getElementById('k-hs-vocab').innerText = bestScores.vocab;
    }

    function kShow(id) { ['k-view-menu','k-view-flash','k-view-quiz'].forEach(i=>document.getElementById(i).classList.add('k-hidden')); document.getElementById(id).classList.remove('k-hidden'); }
    function kShowMenu() { kUpdateStats(); kShow('k-view-menu'); }

    function kStart(type, mode, subMode='normal') {
        curType = type; curMode = mode; curSubMode = subMode; curIdx = 0; curStreak = 0; quizPhase = 1;
        document.getElementById('k-streak').innerText = 0;

        // DETERMINE CATEGORY
        if (mode === 'quiz-meaning') curCategory = 'meaning';
        else if (mode === 'quiz-reading') curCategory = 'reading';
        else if (mode === 'quiz-vocab') curCategory = 'vocab';
        else if (mode === 'quiz-conj') curCategory = 'verb';
        else curCategory = '';

        // LOAD CORRECT BEST SCORE
        curBest = bestScores[curCategory] || 0;
        document.getElementById('k-best').innerText = curBest;

        if(type==='kanji') curSet = DB.kanji.filter(k => activeLessons.has(k.lesson));
        else curSet = [...DB.verb];

        if(curSet.length === 0) return alert("Please select at least one lesson.");
        curSet.sort(() => Math.random() - 0.5);
        if(mode === 'flash') { kRenderFC(); kShow('k-view-flash'); } else { kNextQ(); kShow('k-view-quiz'); }
    }

    function kRenderFC() {
        const d = curSet[curIdx];
        document.getElementById('k-fc-progress').innerText = `Card ${curIdx+1} / ${curSet.length}`;
        document.getElementById('k-fc-back').classList.add('k-hidden'); document.getElementById('k-btn-flip').classList.remove('k-hidden');
        const oldStamp = document.querySelector('.k-flag-stamp'); if(oldStamp) oldStamp.remove();
        if(d.isRequeued) {
            const stamp = document.createElement('div'); stamp.className = 'k-flag-stamp'; stamp.innerText = 'AGAIN';
            document.getElementById('k-fc-card-container').appendChild(stamp);
        }

        if(curType==='kanji') {
            document.getElementById('k-fc-lbl').innerText = d.class;
            document.getElementById('k-fc-main').innerText = d.kanji; document.getElementById('k-fc-sub').innerText = "";
            let h = `<div style="text-align:center; font-weight:700; font-size:2rem; margin-bottom:15px; color:var(--primary); line-height:1.2;">${d.meaning}</div>`;
            const flags = flagCounts[d.kanji] || 0;
            if(flags > 0) h += `<div style="text-align:center; color:#ff4757; font-weight:700; margin-bottom:15px; font-size:0.95rem;">üö© Flagged: ${flags} times</div>`;
            h += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                    <div style="background:#f8f9fa; padding:10px; border-radius:8px;"><div style="font-size:0.8rem; color:#aaa; font-weight:700;">ON-YOMI</div><div style="font-size:1.4rem; font-weight:600;">${d.on||'-'}</div></div>
                    <div style="background:#f8f9fa; padding:10px; border-radius:8px;"><div style="font-size:0.8rem; color:#aaa; font-weight:700;">KUN-YOMI</div><div style="font-size:1.4rem; font-weight:600;">${d.kun||'-'}</div></div>
                  </div>`;
            h += `<div class="k-lbl" style="text-align:left;margin-top:15px;border-bottom:1px solid #eee;">Compounds</div><table class="k-tbl">`;
            const cs=(d.compounds||'').split(';'), rs=(d.comp_readings||'').split(';'), ms=(d.comp_meanings||'').split(';');
            cs.forEach((c,i)=>{ if(c) h+=`<tr><td style="font-weight:bold; font-size:1.4rem">${c}</td><td><div style="font-size:1.15rem">${rs[i]||''}</div><div style="color:#747d8c; font-size:1rem">${ms[i]||''}</div></td></tr>`; });
            document.getElementById('k-fc-back').innerHTML = h+'</table>';
        } else {
            document.getElementById('k-fc-lbl').innerText = 'Verb'; document.getElementById('k-fc-main').innerText = d.kanji==='-'?d.dict:d.kanji; document.getElementById('k-fc-sub').innerText = `${d.meaning} (${d.dict})`;
            let h = `<div style="text-align:center; font-weight:700; font-size:2rem; margin-bottom:15px; color:var(--primary);">${d.meaning}</div>`;
            h += `<table class="k-tbl"><tr><th>Masu</th><td>${d.masu}</td></tr><tr><th>Te</th><td>${d.te}</td></tr><tr><th>Nai</th><td>${d.nai}</td></tr><tr><th>Ta</th><td>${d.ta}</td></tr><tr><th>Potential</th><td>${d.potential}</td></tr></table>`;
            document.getElementById('k-fc-back').innerHTML = h;
        }
    }
    function kFlip() { document.getElementById('k-fc-back').classList.remove('k-hidden'); document.getElementById('k-btn-flip').classList.add('k-hidden'); }
    function kMove(n) { curIdx = (curIdx+n+curSet.length)%curSet.length; kRenderFC(); }
    function kFlag(btn) {
        const currentItem = curSet[curIdx];
        const kKey = currentItem.kanji || currentItem.dict;
        flagCounts[kKey] = (flagCounts[kKey] || 0) + 1;
        localStorage.setItem('k-flags', JSON.stringify(flagCounts));
        curSet.push({ ...currentItem, isRequeued: true });
        const originalText = btn.innerText;
        btn.innerText = "Re-queued! ‚Ü∫"; btn.style.backgroundColor = "#fff3cd";
        setTimeout(() => { btn.innerText = originalText; btn.style.backgroundColor = ""; }, 800);
        kMove(1);
    }

    function kNextQ() {
        document.getElementById('k-q-msg').classList.add('k-hidden');
        document.getElementById('k-q-next').classList.add('k-hidden');
        document.getElementById('k-q-opts').innerHTML = '';
        document.getElementById('k-q-read-reveal').classList.add('k-hidden'); // Reset reading reveal
        quizPhase = 1;

        let q='', a='', m='', dists=[];
        curQItem = curSet[Math.floor(Math.random()*curSet.length)];

        let effectiveSubMode = curSubMode;
        if(curSubMode === 'mix') effectiveSubMode = Math.random() < 0.5 ? 'normal' : 'reverse';
        curQItem.activeMode = effectiveSubMode;

        if(curMode==='quiz-meaning') {
            if(effectiveSubMode === 'normal') {
                q='What does this mean?'; m=curQItem.kanji; a=curQItem.meaning; dists = kRand(curSet, 'meaning', a);
            } else {
                q='Which Kanji means...'; m=curQItem.meaning; a=curQItem.kanji; dists = kRand(curSet, 'kanji', a);
            }
        } else if(curMode==='quiz-reading') {
            if(effectiveSubMode === 'normal') {
                q='Select readings'; m=curQItem.kanji; a=[curQItem.on,curQItem.kun].filter(x=>x).join(' / ');
                let safe=0; while(dists.length<3 && safe++<50) { let r=curSet[Math.floor(Math.random()*curSet.length)]; let x=[r.on,r.kun].filter(y=>y).join(' / '); if(x!==a && !dists.includes(x)) dists.push(x); }
            } else {
                q='Which Kanji reads...'; m=[curQItem.on,curQItem.kun].filter(x=>x).join(' / '); a=curQItem.kanji;
                dists = kRand(curSet, 'kanji', a);
            }
        } else if(curMode==='quiz-vocab') {
            const cs=(curQItem.compounds||'').split(';');
            const rs=(curQItem.comp_readings||'').split(';');
            const ms=(curQItem.comp_meanings||'').split(';');
            let pairs=[]; cs.forEach((c,i)=>{ if(c&&ms[i]&&rs[i]) pairs.push({c:c, m:ms[i], r:rs[i]}); });
            if(!pairs.length) return kNextQ();
            curVocabItem = pairs[Math.floor(Math.random()*pairs.length)];
            q='What is the meaning?'; m=curVocabItem.c; a=curVocabItem.m;
            let safe=0; while(dists.length<3 && safe++<50) {
                 let r=curSet[Math.floor(Math.random()*curSet.length)], rms=(r.comp_meanings||'').split(';');
                 let x=rms[Math.floor(Math.random()*rms.length)]; if(x&&x!==a&&!dists.includes(x)) dists.push(x);
            }
        } else if(curMode==='quiz-conj') {
            const forms=['masu','te','nai','ta','potential']; const f=forms[Math.floor(Math.random()*forms.length)];
            const lbls={'masu':'Polite','te':'Te-Form','nai':'Negative','ta':'Past','potential':'Potential'};
            q=`What is the ${lbls[f]} form?`; m=`${curQItem.meaning} (${curQItem.dict})`; a=curQItem[f];
            let safe=0; while(dists.length<3 && safe++<50) { let r=curSet[Math.floor(Math.random()*curSet.length)]; if(r[f]!==a && !dists.includes(r[f])) dists.push(r[f]); }
        }

        curAns = a;
        document.getElementById('k-q-ask').innerText = q;
        document.getElementById('k-q-main').innerText = m;
        // Adjust font size for Reverse Mode (English Text) vs Kanji
        // Normal Meaning: Kanji (Big)
        // Reverse Meaning: Eng (Small)
        // Normal Reading: Kanji (Big)
        // Reverse Reading: Kana (Small)
        const isBig = (curMode==='quiz-meaning' && effectiveSubMode==='normal') || (curMode==='quiz-reading' && effectiveSubMode==='normal');
        document.getElementById('k-q-main').style.fontSize = isBig ? '5rem' : '2.5rem';
        kRenderOpts(a, dists);
    }

    function kRenderOpts(ans, dists) {
        let opts = [ans, ...dists].sort(()=>Math.random()-0.5);
        document.getElementById('k-q-opts').innerHTML = '';
        opts.forEach(o => {
            let b = document.createElement('div'); b.className='k-opt'; b.innerText=o;
            b.onclick = ()=>kCheck(o, b);
            document.getElementById('k-q-opts').appendChild(b);
        });
    }

    function kCheck(sel, btn) {
        if(!document.getElementById('k-q-next').classList.contains('k-hidden')) return;
        const msg = document.getElementById('k-q-msg');

        if(sel===curAns) {
            btn.classList.add('correct'); curStreak++;

            // REVEAL LOGIC
            const readEl = document.getElementById('k-q-read-reveal');

            if(curMode === 'quiz-meaning') {
                // Show Reading (On/Kun)
                readEl.innerText = [curQItem.on, curQItem.kun].filter(x => x).join(' / ');
                readEl.classList.remove('k-hidden');
            } else if (curMode === 'quiz-reading') {
                // Show Meaning (English)
                readEl.innerText = curQItem.meaning;
                readEl.classList.remove('k-hidden');
            }

            if(curMode === 'quiz-vocab' && quizPhase === 1) {
                msg.innerText = "Correct! BONUS ROUND: Select the Reading";
                msg.style.color="#155724"; msg.style.background="#d4edda"; msg.classList.remove('k-hidden');
                setTimeout(() => {
                    quizPhase = 2;
                    document.getElementById('k-q-ask').innerText = "What is the reading?";
                    let dists = []; let safe=0;
                    while(dists.length<3 && safe++<50) {
                        let r=curSet[Math.floor(Math.random()*curSet.length)];
                        let rrs=(r.comp_readings||'').split(';');
                        let x=rrs[Math.floor(Math.random()*rrs.length)];
                        if(x && x!==curVocabItem.r && !dists.includes(x)) dists.push(x);
                    }
                    curAns = curVocabItem.r;
                    msg.classList.add('k-hidden');
                    kRenderOpts(curAns, dists);
                }, 800);
                return;
            }

            // UPDATE HIGH SCORE FOR SPECIFIC CATEGORY
            if(curStreak > curBest) {
                curBest = curStreak;
                if(curCategory) {
                    bestScores[curCategory] = curBest;
                    localStorage.setItem('k-best-' + curCategory, curBest);
                }
            }
            msg.innerText=`Correct! Streak: ${curStreak} üî•`;
            msg.style.color="#155724"; msg.style.background="#d4edda";
        } else {
            btn.classList.add('wrong'); curStreak = 0;
            msg.innerText=`Wrong! It was: ${curAns}`;
            msg.style.color="#721c24"; msg.style.background="#f8d7da";
            document.querySelectorAll('.k-opt').forEach(b=>{if(b.innerText===curAns)b.classList.add('correct')});
        }

        document.getElementById('k-streak').innerText = curStreak;
        document.getElementById('k-best').innerText = curBest;
        msg.classList.remove('k-hidden');
        document.getElementById('k-q-next').classList.remove('k-hidden');
    }

    function kRand(set, key, exc) {
        let res=[]; let s=0;
        while(res.length<3 && s++<100) { let r=set[Math.floor(Math.random()*set.length)][key]; if(r!==exc && !res.includes(r)) res.push(r); }
        return res;
    }
</script>
